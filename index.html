<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prière Accessible</title>
  <meta name="description" content="Horaires de prière accessibles pour iPhone et VoiceOver." />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header>
  <h1>Prière Accessible</h1>
  <p>Application d'horaires de prière accessible pour iPhone.</p>
  <button id="helpButton" aria-controls="helpPanel" aria-expanded="false">Aide</button>
</header>

<main>
  <section aria-labelledby="date-title">
    <h2 id="date-title">Aujourd'hui</h2>
    <p id="currentDate">Date en chargement</p>
    <p id="currentLocation">Lieu non configuré.</p>
  </section>

  <section id="nextPrayerSection" aria-live="polite" role="status">
    <h2>Prochaine prière</h2>
    <p id="nextPrayerName">Chargement</p>
    <p id="nextPrayerTime"></p>
  </section>

  <section aria-labelledby="list-title">
    <h2 id="list-title">Prières du jour</h2>
    <ul id="prayerList"></ul>
  </section>

  <section class="actions">
    <button id="announceNextButton">Annoncer la prochaine prière</button>
    <button id="readAllButton">Lire tous les horaires de la journée</button>
  </section>

  <section aria-labelledby="dua-title">
    <h2 id="dua-title">Douas et invocations</h2>
    <p>Invocations importantes à réciter en français.</p>

    <div class="dua-item">
      <h3>Avant la prière</h3>
      <p class="dua-text">
        Bismillah, Allahou Akbar. Je me tourne vers Toi, ô Allah, avec l'intention de faire cette prière pour Ta satisfaction.
      </p>
      <button class="dua-button"
              data-dua="Avant la prière : Bismillah, Allahou Akbar. Je me tourne vers Toi, ô Allah, avec l'intention de faire cette prière pour Ta satisfaction.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Après la prière</h3>
      <p class="dua-text">
        Astaghfiroullah, Astaghfiroullah, Astaghfiroullah. Ô Allah, pardonne-moi mes péchés et accepte ma prière. Que la paix et les bénédictions soient sur le Prophète Muhammad.
      </p>
      <button class="dua-button"
              data-dua="Après la prière : Astaghfiroullah, Astaghfiroullah, Astaghfiroullah. Ô Allah, pardonne-moi mes péchés et accepte ma prière. Que la paix et les bénédictions soient sur le Prophète Muhammad.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Doua du matin</h3>
      <p class="dua-text">
        Allahoumma bika asbahna, wa bika amsayna, wa bika nahya, wa bika namout, wa ilayka an-nouchour. Ô Allah, par Toi nous entrons dans le matin, par Toi nous entrons dans le soir, par Toi nous vivons, par Toi nous mourons, et vers Toi est le retour.
      </p>
      <button class="dua-button"
              data-dua="Doua du matin : Allahoumma bika asbahna, wa bika amsayna, wa bika nahya, wa bika namout, wa ilayka an-nouchour. Ô Allah, par Toi nous entrons dans le matin, par Toi nous entrons dans le soir, par Toi nous vivons, par Toi nous mourons, et vers Toi est le retour.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Doua du soir</h3>
      <p class="dua-text">
        Allahoumma bika amsayna, wa bika asbahna, wa bika nahya, wa bika namout, wa ilayka al-massir. Ô Allah, par Toi nous entrons dans le soir, par Toi nous entrons dans le matin, par Toi nous vivons, par Toi nous mourons, et vers Toi est la destinée.
      </p>
      <button class="dua-button"
              data-dua="Doua du soir : Allahoumma bika amsayna, wa bika asbahna, wa bika nahya, wa bika namout, wa ilayka al-massir. Ô Allah, par Toi nous entrons dans le soir, par Toi nous entrons dans le matin, par Toi nous vivons, par Toi nous mourons, et vers Toi est la destinée.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Avant de manger</h3>
      <p class="dua-text">
        Bismillah. Au nom d'Allah, je commence. Ô Allah, bénis ce repas et facilite-nous la subsistance licite.
      </p>
      <button class="dua-button"
              data-dua="Avant de manger : Bismillah. Au nom d'Allah, je commence. Ô Allah, bénis ce repas et facilite-nous la subsistance licite.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Après avoir mangé</h3>
      <p class="dua-text">
        Alhamdoulillah. Louange à Allah qui nous a nourris et nous a donné à boire, et qui a fait de nous des musulmans.
      </p>
      <button class="dua-button"
              data-dua="Après avoir mangé : Alhamdoulillah. Louange à Allah qui nous a nourris et nous a donné à boire, et qui a fait de nous des musulmans.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>En entrant dans la maison</h3>
      <p class="dua-text">
        Bismillah walajna, wa bismillah kharajna, wa 'ala rabbina tawakkalna. Au nom d'Allah nous entrons, au nom d'Allah nous sortons, et c'est en notre Seigneur que nous plaçons notre confiance.
      </p>
      <button class="dua-button"
              data-dua="En entrant dans la maison : Bismillah walajna, wa bismillah kharajna, wa 'ala rabbina tawakkalna. Au nom d'Allah nous entrons, au nom d'Allah nous sortons, et c'est en notre Seigneur que nous plaçons notre confiance.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Demander le pardon</h3>
      <p class="dua-text">
        Astaghfiroullah al-'adhim, alladhi la ilaha illa houwa al-Hayy al-Qayyoum, wa atoubou ilayh. Je demande pardon à Allah le Très Grand, il n'y a de divinité que Lui, le Vivant, l'Éternel, et je me repens vers Lui.
      </p>
      <button class="dua-button"
              data-dua="Demander le pardon : Astaghfiroullah al-'adhim, alladhi la ilaha illa houwa al-Hayy al-Qayyoum, wa atoubou ilayh. Je demande pardon à Allah le Très Grand, il n'y a de divinité que Lui, le Vivant, l'Éternel, et je me repens vers Lui.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Tasbih (Glorification)</h3>
      <p class="dua-text">
        Soubhanallah, Alhamdoulillah, Allahou Akbar. Gloire à Allah, Louange à Allah, Allah est le Plus Grand. (Répéter 33 fois chacune)
      </p>
      <button class="dua-button"
              data-dua="Tasbih : Soubhanallah, Alhamdoulillah, Allahou Akbar. Gloire à Allah, Louange à Allah, Allah est le Plus Grand. Répéter 33 fois chacune.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>Demander la guidance</h3>
      <p class="dua-text">
        Rabbi zidni 'ilma. Ô mon Seigneur, augmente-moi en connaissance. Rabbi chrahli sadri, wa yassirli amri. Ô mon Seigneur, ouvre-moi la poitrine et facilite-moi ma tâche.
      </p>
      <button class="dua-button"
              data-dua="Demander la guidance : Rabbi zidni 'ilma. Ô mon Seigneur, augmente-moi en connaissance. Rabbi chrahli sadri, wa yassirli amri. Ô mon Seigneur, ouvre-moi la poitrine et facilite-moi ma tâche.">
        Écouter
      </button>
    </div>

    <div class="dua-item">
      <h3>En cas de difficulté</h3>
      <p class="dua-text">
        Hasbounallahu wa ni'mal wakeel. Allah nous suffit et Il est le Meilleur des garants. La hawla wa la quwwata illa billah. Il n'y a de force ni de puissance qu'en Allah.
      </p>
      <button class="dua-button"
              data-dua="En cas de difficulté : Hasbounallahu wa ni'mal wakeel. Allah nous suffit et Il est le Meilleur des garants. La hawla wa la quwwata illa billah. Il n'y a de force ni de puissance qu'en Allah.">
        Écouter
      </button>
    </div>

    <button id="readAllDuasButton" class="read-all-button">
      Lire toutes les invocations
    </button>
  </section>

  <section aria-labelledby="settings-title">
    <h2 id="settings-title">Réglages rapides</h2>
    <form id="settingsForm">
      <label>Ville
        <input type="text" id="cityInput" placeholder="Paris" />
      </label>
      <label>Pays
        <input type="text" id="countryInput" placeholder="France" />
      </label>
      <label>Latitude
        <input type="number" id="latInput" step="0.0001" placeholder="48.8566" />
      </label>
      <label>Longitude
        <input type="number" id="lonInput" step="0.0001" placeholder="2.3522" />
      </label>
      <label>Méthode de calcul
        <select id="methodSelect">
          <option value="3">Muslim World League</option>
          <option value="4">Umm al-Qura</option>
          <option value="5">Egyptian General Authority</option>
        </select>
      </label>
      <label>Madhhab pour Asr
        <select id="schoolSelect">
          <option value="0">Standard</option>
          <option value="1">Hanafi</option>
        </select>
      </label>
      <label class="toggle">
        <input type="checkbox" id="welcomeToggle" />
        Lire "De la part de ton amoureux, Anas."
      </label>
      <button type="submit">Sauvegarder les réglages</button>
    </form>
  </section>
</main>

<aside id="helpPanel" hidden tabindex="-1">
  <h2>Aide</h2>
  <p>Balaye du haut vers le bas avec VoiceOver pour lire la page.</p>
  <p>La section "Prochaine prière" annonce automatiquement les changements.</p>
  <p>Le bouton "Annoncer la prochaine prière" lit la prochaine prière à voix haute.</p>
  <p>Le bouton "Lire tous les horaires" lit les cinq prières du jour.</p>
  <p>Dans les réglages, tu peux changer la ville, le pays, la méthode de calcul et activer ou désactiver le message "De la part de ton amoureux, Anas.".</p>
  <p>Après avoir modifié les réglages, valide avec "Sauvegarder les réglages".</p>
  <p>La section "Douas et invocations" contient des invocations importantes à réciter. Chaque invocation a un bouton "Écouter" pour l'entendre à voix haute. Tu peux aussi utiliser le bouton "Lire toutes les invocations" pour les entendre toutes à la suite.</p>
</aside>

<div id="statusMessage" role="alert" aria-live="assertive"></div>

<!-- TOUT le JavaScript est ici -->
<script>
  // -------------------------------
  // Réglages & état global
  // -------------------------------
  const DEFAULT_SETTINGS = {
    city: "Lille",
    country: "France",
    lat: "",
    lon: "",
    method: 3,   // Muslim World League
    school: 0,   // Standard
    welcomeEnabled: true,
  };

  let settings = { ...DEFAULT_SETTINGS };
  let prayerList = []; // { id, label, time: Date, raw }
  let nextPrayer = null;
  let hasPlayedWelcome = false;

  // -------------------------------
  // Utilitaires DOM
  // -------------------------------
  const $ = (id) => document.getElementById(id);

  const currentDateEl     = $("currentDate");
  const currentLocationEl = $("currentLocation");
  const nextPrayerNameEl  = $("nextPrayerName");
  const nextPrayerTimeEl  = $("nextPrayerTime");
  const prayerListEl      = $("prayerList");

  const announceNextBtn   = $("announceNextButton");
  const readAllBtn        = $("readAllButton");
  const readAllDuasButton = $("readAllDuasButton");

  const helpButton        = $("helpButton");
  const helpPanel         = $("helpPanel");
  const statusMessageEl   = $("statusMessage");

  const settingsForm  = $("settingsForm");
  const cityInput     = $("cityInput");
  const countryInput  = $("countryInput");
  const latInput      = $("latInput");
  const lonInput      = $("lonInput");
  const methodSelect  = $("methodSelect");
  const schoolSelect  = $("schoolSelect");
  const welcomeToggle = $("welcomeToggle");

  // -------------------------------
  // Utilitaires date / format
  // -------------------------------
  function formatDateFr(d) {
    return d.toLocaleDateString("fr-FR", {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }

  function formatTimeFr(d) {
    return d.toLocaleTimeString("fr-FR", {
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  // -------------------------------
  // Synthèse vocale
  // -------------------------------
  function speak(text) {
    if (!("speechSynthesis" in window)) {
      console.warn("Synthèse vocale non supportée");
      return;
    }
    const synth = window.speechSynthesis;
    synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "fr-FR";
    synth.speak(utter);
  }

  function maybeSpeakWelcome() {
    if (!settings.welcomeEnabled || hasPlayedWelcome) return;
    hasPlayedWelcome = true;
    speak("De la part de ton amoureux, Anas.");
  }

  // -------------------------------
  // Réglages (localStorage)
  // -------------------------------
  const SETTINGS_KEY = "priereAccessible.settings";

  function loadSettings() {
    try {
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      settings = { ...DEFAULT_SETTINGS, ...parsed };
    } catch (e) {
      console.warn("Impossible de charger les réglages, utilisation des defaults :", e);
      settings = { ...DEFAULT_SETTINGS };
    }
  }

  function saveSettings() {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  function applySettingsToForm() {
    cityInput.value       = settings.city || "";
    countryInput.value    = settings.country || "";
    latInput.value        = settings.lat || "";
    lonInput.value        = settings.lon || "";
    methodSelect.value    = String(settings.method);
    schoolSelect.value    = String(settings.school);
    welcomeToggle.checked = !!settings.welcomeEnabled;
  }

  function updateSettingsFromForm() {
    settings.city   = cityInput.value.trim() || DEFAULT_SETTINGS.city;
    settings.country = countryInput.value.trim() || DEFAULT_SETTINGS.country;
    settings.lat    = latInput.value.trim();
    settings.lon    = lonInput.value.trim();
    settings.method = Number(methodSelect.value || DEFAULT_SETTINGS.method);
    settings.school = Number(schoolSelect.value || DEFAULT_SETTINGS.school);
    settings.welcomeEnabled = welcomeToggle.checked;
  }

  // -------------------------------
  // Appel API AlAdhan
  // -------------------------------
  async function fetchPrayerTimes() {
    const today = new Date();
    const day   = today.getDate();
    const month = today.getMonth() + 1;
    const year  = today.getFullYear();

    let url;
    if (settings.lat && settings.lon) {
      url = `https://api.aladhan.com/v1/timings?latitude=${encodeURIComponent(
        settings.lat
      )}&longitude=${encodeURIComponent(
        settings.lon
      )}&method=${settings.method}&school=${settings.school}&day=${day}&month=${month}&year=${year}`;
    } else {
      url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(
        settings.city
      )}&country=${encodeURIComponent(
        settings.country
      )}&method=${settings.method}&school=${settings.school}&day=${day}&month=${month}&year=${year}`;
    }

    console.log("Appel API AlAdhan :", url);

    const res = await fetch(url);
    if (!res.ok) {
      throw new Error("Réponse réseau incorrecte : " + res.status);
    }
    const json = await res.json();
    if (json.code !== 200 || !json.data || !json.data.timings) {
      console.error("Réponse API inattendue :", json);
      throw new Error("Format de données inattendu");
    }

    return json.data.timings;
  }

  // -------------------------------
  // Construction & calcul des prières
  // -------------------------------
  function buildPrayerList(timings) {
    const today = new Date();
    const [year, month, day] = [
      today.getFullYear(),
      today.getMonth(),
      today.getDate(),
    ];

    const mapping = [
      { id: "Fajr",    label: "Fajr" },
      { id: "Dhuhr",   label: "Dhor" },
      { id: "Asr",     label: "Asr" },
      { id: "Maghrib", label: "Maghrib" },
      { id: "Isha",    label: "Isha" },
    ];

    return mapping.map((p) => {
      const raw = timings[p.id]; // ex "05:24"
      const [h, m] = raw.split(":").map((v) => parseInt(v, 10));
      const d = new Date(year, month, day, h, m, 0, 0);
      return { id: p.id, label: p.label, time: d, rawString: raw };
    });
  }

  function computeNextPrayer(prayers) {
    const now = new Date();
    const upcoming = prayers.filter((p) => p.time > now);
    if (!upcoming.length) return null;
    upcoming.sort((a, b) => a.time - b.time);
    return upcoming[0];
  }

  // -------------------------------
  // Rendu
  // -------------------------------
  function renderDateAndLocation() {
    const now = new Date();
    currentDateEl.textContent = formatDateFr(now);

    if (settings.lat && settings.lon) {
      currentLocationEl.textContent =
        `Coordonnées : ${settings.lat}, ${settings.lon} (méthode ${settings.method}, école ${settings.school})`;
    } else {
      currentLocationEl.textContent =
        `Lieu : ${settings.city}, ${settings.country} (méthode ${settings.method}, école ${settings.school})`;
    }
  }

  function renderPrayerList() {
    prayerListEl.innerHTML = "";
    const now = new Date();

    prayerList.forEach((p) => {
      const li = document.createElement("li");
      const status = p.time > now ? "À venir" : "Déjà passée";
      li.textContent = `${p.label} : ${formatTimeFr(p.time)} — ${status}`;
      prayerListEl.appendChild(li);
    });
  }

  function renderNextPrayer() {
    if (!nextPrayer) {
      nextPrayerNameEl.textContent = "Aucune autre prière aujourd'hui.";
      nextPrayerTimeEl.textContent = "";
      return;
    }
    nextPrayerNameEl.textContent = `Prochaine prière : ${nextPrayer.label}`;
    nextPrayerTimeEl.textContent = `À ${formatTimeFr(nextPrayer.time)}.`;
  }

  function setStatusMessage(msg) {
    if (!statusMessageEl) return;
    statusMessageEl.textContent = msg || "";
  }

  // -------------------------------
  // Actions : prières
  // -------------------------------
  function handleAnnounceNext() {
    maybeSpeakWelcome();
    if (!nextPrayer) {
      speak("Aucune autre prière à venir pour aujourd’hui.");
      return;
    }
    const text = `Prochaine prière : ${nextPrayer.label} à ${formatTimeFr(nextPrayer.time)}.`;
    speak(text);
  }

  function handleReadAll() {
    maybeSpeakWelcome();
    if (!prayerList.length) {
      speak("Aucun horaire de prière n’est disponible.");
      return;
    }
    const parts = prayerList.map(
      (p) => `Salat ${p.label} à ${formatTimeFr(p.time)}.`
    );
    speak(parts.join(" "));
  }

  // -------------------------------
  // Douas
  // -------------------------------
  function handleDuaClick(e) {
    const btn = e.target.closest(".dua-button");
    if (!btn) return;
    const duaText = btn.getAttribute("data-dua");
    if (duaText) {
      maybeSpeakWelcome();
      speak(duaText);
    }
  }

  function handleReadAllDuas() {
    const buttons = document.querySelectorAll(".dua-button[data-dua]");
    const texts = Array.from(buttons)
      .map((b) => b.getAttribute("data-dua"))
      .filter(Boolean);
    if (!texts.length) return;
    maybeSpeakWelcome();
    speak(texts.join(" "));
  }

  // -------------------------------
  // Aide
  // -------------------------------
  function toggleHelpPanel() {
    const isHidden = helpPanel.hasAttribute("hidden");
    if (isHidden) {
      helpPanel.removeAttribute("hidden");
      helpButton.setAttribute("aria-expanded", "true");
      helpPanel.focus();
    } else {
      helpPanel.setAttribute("hidden", "");
      helpButton.setAttribute("aria-expanded", "false");
    }
  }

  // -------------------------------
  // Initialisation
  // -------------------------------
  async function init() {
    loadSettings();
    applySettingsToForm();
    renderDateAndLocation();

    setStatusMessage("Chargement des horaires de prière...");

    try {
      const timings = await fetchPrayerTimes();
      prayerList = buildPrayerList(timings);
      nextPrayer = computeNextPrayer(prayerList);
      renderPrayerList();
      renderNextPrayer();
      setStatusMessage("Horaires chargés avec succès.");
    } catch (e) {
      console.error(e);
      setStatusMessage(
        "Impossible de charger les horaires de prière. Vérifie ta connexion Internet."
      );
      nextPrayerNameEl.textContent = "Erreur de chargement.";
    }

    // Boutons prières
    announceNextBtn.addEventListener("click", handleAnnounceNext);
    readAllBtn.addEventListener("click", handleReadAll);

    // Douas
    document.addEventListener("click", handleDuaClick);
    if (readAllDuasButton) {
      readAllDuasButton.addEventListener("click", handleReadAllDuas);
    }

    // Aide
    if (helpButton && helpPanel) {
      helpButton.addEventListener("click", toggleHelpPanel);
    }

    // Réglages
    if (settingsForm) {
      settingsForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        updateSettingsFromForm();
        saveSettings();
        hasPlayedWelcome = false;
        renderDateAndLocation();
        setStatusMessage("Réglages sauvegardés. Rechargement des horaires...");

        try {
          const timings = await fetchPrayerTimes();
          prayerList = buildPrayerList(timings);
          nextPrayer = computeNextPrayer(prayerList);
          renderPrayerList();
          renderNextPrayer();
          setStatusMessage("Horaires mis à jour.");
        } catch (err) {
          console.error(err);
          setStatusMessage(
            "Impossible de recharger les horaires avec les nouveaux réglages."
          );
        }
      });
    }
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
